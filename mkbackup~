#!/bin/bash
PATH=/opt/someApp/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

## backup
# en crontab -e add to run every day at 23:59
# m h  dom mon dow   command
# 59 23 * * * cd $HOME/kamaoo;./mkbackup

# TODO: get a ramdom file pro process another image in crea_grafica-colores.py
# randomfile=(*.png); echo "${answer[RANDOM % ${#randomfile[@]}]}"
directory="/home/deb/kamaoo"

cd "$directory"
echo "creating backup ...wait ..."
fecha=$(date +"%Y-%m-%d.%H:%M")

cp "$directory/lita_chat.log" "$directory/lita_chat.log.tmp"
cp "$directory/lita_chat.log" "$directory/$fecha-chat.log"
cp "$directory/lita_chat.log" "$directory/lita_chat.log.bk"
rm "lita_chat.log"

mkdir "$directory/logs/$fecha"
touch "$directory/logs/$fecha/log"
##echo "--- kamaoo ver 0.01b ---repo at: https://github.com/leprechuanese/kamaoo$fecha" >> "$directory/logs/$fecha/log"

echo "...creating $directory/words.$fecha.png"
$directory/solo_palabras "$directory/lita_chat.log.tmp"  > "$directory/data-log"

tmp2="--- Most frecuent words (Total Unique Count: $(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr | wc -w)) ---"
tmp3="$(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr)"

"$directory/crea_grafica-colored.py"
tmp=$(curl -F c=@$directory/fn-worldcloud-color.png https://ptpb.pw)

echo "--- words.$fecha.png ---" >> "$directory/logs/$fecha/log"
echo "$tmp" >> "$directory/logs/$fecha/log"
echo >> "$directory/logs/$fecha/log"

mv "$directory/fn-worldcloud-color.png" "$directory/logs/$fecha/words.$fecha.png" >> "$directory/logs/$fecha/log"

echo "...creating $directory/users.$fecha.png"

$directory/solo_users "$directory/lita_chat.log.tmp"  > "$directory/data-log"
"$directory/crea_grafica-colored.py"
tmp=$(curl -F c=@$directory/fn-worldcloud-color.png https://ptpb.pw)

echo "--- $directory/users.$fecha.png ---" >> "$directory/logs/$fecha/log"
echo "$tmp" >> "$directory/logs/$fecha/log"
echo >> "$directory/logs/$fecha/log"
mv "$directory/fn-worldcloud-color.png" "$directory/logs/$fecha/users.$fecha.png"

tmp4="--- User Count: $(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr | wc -w) ---"
tmp4="$tmp4 First Place: $(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr | head -3 | awk '{print $2}')"

tmp5="$(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr)"

num=1
for i in $(awk -F '\t' '{print $1}' $directory/data-log | sort | uniq -c | sort -nr | head -3 | awk '{print $2}'); do
	echo "Creating $directory/$num-place.$i.$fecha.png"
	$directory/solo_palabras "$directory/lita_chat.log.tmp" "$i" > "$directory/data-log"
	"$directory/crea_grafica-colored.py"
	tmp=$(curl -F c=@$directory/fn-worldcloud-color.png https://ptpb.pw)
	echo "--- $directory/$num-place.$i.$fecha ---" >> "$directory/logs/$fecha/log"
	echo "$tmp" >> "$directory/logs/$fecha/log"
	echo >> "$directory/logs/$fecha/log"
	mv "$directory/fn-worldcloud-color.png" "$directory/logs/$fecha/$num-place.$i.$fecha.png"
	let num=num+1
done

echo "$tmp2" >> "$directory/logs/$fecha/log"
echo "$tmp4" >> "$directory/logs/$fecha/log"
echo "--- Words ---" >> "$directory/logs/$fecha/log"
echo "$tmp3" >> "$directory/logs/$fecha/log"
echo "--- Users ---" >> "$directory/logs/$fecha/log"
echo "$tmp5" >> "$directory/logs/$fecha/log"

cp "$directory/lita_chat.log" "$directory/logs/$fecha/lita_chat.log"

echo "compressing folder ..."
tar -zcvf "$directory/logs/$fecha.tar.gz" "$directory/logs/$fecha"

echo "cleaning up ..."
rm -rf "$directory/logs/$fecha"
cp "$directory/lita_chat.log.tmp" "lita_chat.log.bk"
rm "$directory/lita_chat.log.tmp"
#rm "$directory/lita_chat.log"
rm "$directory/data-log"

echo "Done!";echo
